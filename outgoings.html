<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª - ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø©</title>
    <style>
        /* 1. Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø¬Ù…Ø§Ù„ÙŠØ© */
        :root {
            --primary-color: #4CAF50; /* Ø£Ø®Ø¶Ø± Ù…Ø±ÙŠØ­ */
            --secondary-color: #007bff;
            --danger-color: #d9534f;
            --bg-light: #f9f9f9;
            --surface-color: #ffffff;
            --border-radius: 12px;
            --input-radius: 8px;
        }

        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ */
        .page-header {
            width: 100%;
            max-width: 550px;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        .page-header h1 {
            margin: 0;
            font-size: 1.8em;
            color: #333;
            font-weight: 700;
        }

        /* Ø²Ø± Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø·Ø§Ø±Ø¦ (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ØµØºÙŠØ±) */
        .emergency-button {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
        }
        .emergency-button:hover {
            background-color: #c9302c;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Ø¨Ø³ÙŠØ·Ø© ÙˆÙ†Ø§Ø¹Ù…Ø©) */
        .expense-form-container {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); /* Ø¸Ù„ Ù†Ø§Ø¹Ù… Ø¬Ø¯Ø§Ù‹ */
            width: 100%;
            max-width: 550px; 
            margin-bottom: 25px;
            border: 1px solid #eee;
        }

        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0; /* Ø­Ø¯ÙˆØ¯ ÙØ§ØªØ­Ø© */
            border-radius: var(--input-radius);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
            outline: none;
        }

        /* Ù…Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ */
        .datetime-input-wrapper {
            position: relative;
            background-color: #f7f7f7;
            border-radius: var(--input-radius);
            padding: 12px 15px;
            display: flex;
            align-items: center;
            border: 1px solid #e0e0e0;
            cursor: pointer;
        }
        .datetime-input-wrapper:hover {
            background-color: #eeeeee;
        }

        .datetime-input-wrapper input {
            position: absolute; /* Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø®Ù„Ù Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ */
            opacity: 0;
            cursor: pointer;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }

        /* ØªØµÙ…ÙŠÙ… Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--input-radius);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }

        .btn-save {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        .btn-save:hover {
            background-color: #43a047;
        }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ù†Ø¬Ø§Ø­ ÙˆØ¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; /* Ù‚ÙŠÙ…Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); 
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 40px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 350px;
        }
        .checkmark-circle {
             /* Ø£Ù†Ù…Ø§Ø· Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§) */
            width: 80px;
            height: 80px;
            position: relative;
            margin: 0 auto 20px;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: scaleIn 0.5s ease-in-out;
        }
        .checkmark {
            width: 40px;
            height: 20px;
            border: 4px solid var(--primary-color);
            border-top: none;
            border-right: none;
            transform: rotate(-45deg);
            opacity: 0;
            animation: checkmarkDraw 0.5s ease-in-out 0.5s forwards;
        }
        @keyframes scaleIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes checkmarkDraw { 0% { width: 0; height: 0; opacity: 1; } 50% { width: 40px; height: 0; opacity: 1; } 100% { width: 40px; height: 20px; opacity: 1; } }

        /* Ø¥Ø¶Ø§ÙØ© Ù†Ù…Ø· Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ */
        .error-message {
            color: var(--danger-color);
            background-color: #fcebeb;
            border: 1px solid var(--danger-color);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }
        
        /* ----------------------------------------------------------------- */
        /* ğŸŒŸ Ø£Ù†Ù…Ø§Ø· Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸŒŸ */
        /* ----------------------------------------------------------------- */
        .payment-toggle-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .payment-option {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: var(--input-radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .payment-option:hover {
            border-color: var(--primary-color);
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø´Ø· */
        .payment-option.active {
            border-color: var(--danger-color); /* Ø­Ø¯ Ø£Ø­Ù…Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ */
            background-color: #fff7f7; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ø¬Ø¯Ø§Ù‹ */
            box-shadow: 0 0 10px rgba(217, 83, 79, 0.3);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ "Ø¨Ù†ÙƒÙƒ" */
        .bank-label {
            font-size: 1.1em;
            font-weight: bold;
            display: block;
            padding: 5px 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            color: white;
            background-color: var(--danger-color); /* Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ */
        }
        /* ØªÙ†Ø³ÙŠÙ‚ "ÙƒØ§Ø´" */
        .cash-label {
            font-size: 0.8em;
            display: block;
            margin-top: 5px;
            color: #777; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ù†Øµ Ø§Ù„ØµØºÙŠØ± */
        }
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒØ§Ø´ (Ù„ØªÙƒÙˆÙ† Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„ØµØºÙŠØ±) */
        .cash-icon {
            font-size: 1.2em;
            margin-left: 5px;
        }
    </style>
</head>
<body>

<div class="page-header">
    <button class="emergency-button" onclick="openEmergencyModal()" title="Ù…ØµØ±ÙˆÙ Ø·Ø§Ø±Ø¦">
        ğŸš¨
    </button>
    <h1>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h1>
</div>

<div id="successModal" class="modal">
    <div class="modal-content">
        <div class="checkmark-circle">
            <div class="checkmark"></div>
        </div>
        <h3>ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!</h3>
        <p>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….</p>
        <p id="additionalSuccessMessage" style="color: #ff9800; font-weight: 600;"></p>
        <button onclick="closeModal('successModal')" class="btn btn-save" style="margin-top: 15px;">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
</div>

<div id="emergencyInputModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal('emergencyInputModal')" style="float:left; cursor:pointer; font-size:1.5em; color:#888;">&times;</span>
        <h3 style="color:var(--danger-color);">Ø¥Ø¯Ø®Ø§Ù„ Ø·Ø§Ø±Ø¦</h3>
        <form id="quickEmergencyForm">

            <div class="form-group">
                <label for="quickAmount">Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <input type="tel" id="quickAmount" name="quickAmount" placeholder="0.00" oninput="formatNumber(this)">
                <span class="amount-unit">Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ</span>
                <div class="alert-message" id="quickAmountAlert"></div>
            </div>

            <div class="form-group">
                <label for="quickReminder">Ù…Ù„Ø§Ø­Ø¸Ø©/ØªØ°ÙƒÙŠØ±: <span style="color:red;">*</span></label>
                <textarea id="quickReminder" name="quickReminder" rows="2" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)" required></textarea>
                <div class="alert-message" id="quickReminderAlert"></div>
            </div>

            <div class="actions" style="justify-content: flex-end;">
                <button type="submit" class="btn" style="background-color: var(--danger-color);">ğŸ’¾ Ø­ÙØ¸ Ø³Ø±ÙŠØ¹</button>
            </div>
        </form>
    </div>
</div>


<div class="expense-form-container main-container">
    <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h2>

    <form id="expenseForm">

        <div class="form-group" data-group="datetime">
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª:</label>
            <div class="datetime-input-wrapper" onclick="document.getElementById('date').click()">
                <span id="displayDateTime">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠÙŠÙ†</span>

                <input type="date" id="date" name="date" required onchange="handleDateChange(this.value)" style="display:none;">
                <input type="time" id="time" name="time" step="1" required style="display:none;" onchange="updateDisplay()">
            </div>
        </div>


        <div class="form-group" data-group="type">
            <label for="expenseType">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ: <span style="color:red;">*</span></label>
            <select id="expenseType" name="expenseType" required onchange="handleExpenseTypeChange()">
                <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù†ÙˆØ¹Ø§Ù‹ --</option>
                <option value="raw_materials">ğŸ“¦ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</option>
                <option value="labor_wages">ğŸ‘· Ø£Ø¬ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„</option>
                <option value="factory_rent">ğŸ  Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ØµÙ†Ø¹</option>
                <option value="electricity_water">âš¡ï¸ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ù…ÙŠØ§Ù‡</option>
                <option value="general_maintenance">ğŸ› ï¸ ØµÙŠØ§Ù†Ø© Ø¹Ø§Ù…Ø©</option>
                <option value="marketing">ğŸ“¢ ØªØ³ÙˆÙŠÙ‚</option>
                <option value="transfer">ğŸšš Ø§Ù„ØªØ±Ø­ÙŠÙ„</option>
                <option value="house_expenses">ğŸ¡ Ø§Ù„Ù…Ù†Ø²Ù„ (Ù†ÙÙ‚Ø§Øª)</option>
                <option value="asset_purchase">ğŸ’ Ø´Ø±Ø§Ø¡ Ø£ØµÙˆÙ„ (Ø¥Ø³ØªØ«Ù…Ø§Ø±)</option>
                <option value="special_expenses">â­ Ù…ØµØ±ÙˆÙØ§Øª Ø®Ø§ØµØ©</option>
            </select>
            <div class="alert-message" id="typeAlert"></div>
        </div>

        <div class="form-group" data-group="detail">
            <label for="expenseDetail">ØªÙØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ: <span style="color:red;">*</span></label>
            <div id="detailFieldContainer" class="dynamic-field-container">
                </div>
            <div class="alert-message" id="detailAlert"></div>
        </div>

        <div class="form-group" data-group="amount">
            <label for="amountInput">Ø§Ù„Ù…Ø¨Ù„Øº: <span style="color:red;">*</span></label>
            <input type="tel" id="amountInput" name="amountInput" value="" placeholder="0.00" required oninput="formatNumber(this); validateAmountLogic(this)">
            <input type="hidden" id="amount" name="amount" value="0"> <span class="amount-unit">Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ</span>
            <div class="alert-message" id="amountAlert"></div>
        </div>

        <div class="form-group" data-group="payment">
            <label for="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
            <div class="payment-toggle-container">
                <div class="payment-option" id="bankakOption" data-value="bankak" onclick="selectPaymentMethod('bankak')">
                    <span class="bank-label">Ø¨Ù†ÙƒÙƒ</span>
                    <span class="cash-label">
                        <span class="cash-icon">ğŸ¦</span> Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø¨Ù†ÙƒÙƒ
                    </span>
                </div>
                <div class="payment-option" id="cashOption" data-value="cash" onclick="selectPaymentMethod('cash')">
                    <span class="bank-label" style="background-color: #6c757d; color: white; font-size: 1em;">ÙƒØ§Ø´</span>
                    <span class="cash-label">
                        <span class="cash-icon">ğŸ’µ</span> Ù†Ù‚Ø¯Ø§Ù‹
                    </span>
                </div>
            </div>
            <input type="hidden" id="paymentMethod" name="paymentMethod" value="cash">
        </div>
        <div class="form-group" data-group="notes">
            <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ"></textarea>
        </div>

        <div class="actions" style="justify-content: flex-end;">
            <button type="submit" class="btn btn-save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        </div>

        <div id="firebaseError" class="error-message">
            <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ…Ù† Ø£Ø°ÙˆÙ†Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
        </div>

    </form>
</div>

<script type="module">
    // ------------------------------------------------------------------
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ±Ø¨Ø· Firebase
    // ------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDZCydTHThyMEMv_x261_HhJB_wZNUr7JA",
      authDomain: "salahsweetgedo.firebaseapp.com",
      projectId: "salahsweetgedo",
      storageBucket: "salahsweetgedo.firebasestorage.app",
      messagingSenderId: "1079672977254",
      appId: "1:1079672977254:web:7e901bb6d55b71c716baa7",
      measurementId: "G-3Y9LT7JXY0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    getAnalytics(app); // ØªØ´ØºÙŠÙ„ ØªØ­Ù„ÙŠÙ„Ø§Øª Firebase

    // ------------------------------------------------------------------
    // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ³Ù…)
    // ------------------------------------------------------------------

    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙŠ Firestore
    async function saveExpenseToFirestore(expenseData) {
        document.getElementById('firebaseError').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡ Ø³Ø§Ø¨Ù‚Ø©

        // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙÙŠ ÙˆÙ‚Øª Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙØ¹Ù„ÙŠ
        const fullData = { 
            ...expenseData, 
            createdAt: new Date().toISOString()
        };

        try {
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© 'expenses'
            const docRef = await addDoc(collection(db, "expenses"), fullData);
            console.log("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: ", docRef.id);
            return true;
        } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯: ", e);
            document.getElementById('firebaseError').style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            return false;
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Firestore
    async function checkDuplicateInFirestore(dateToCompare, type, detail) {
        const dayToCompare = getDatePart(dateToCompare);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…ØŒ Ø¨Ù†ÙØ³ Ø§Ù„Ù†ÙˆØ¹ØŒ ÙˆÙ†ÙØ³ Ø§Ù„ØªÙØµÙŠÙ„
        const expensesRef = collection(db, "expenses");
        const q = query(expensesRef, 
            where("datePart", "==", dayToCompare),
            where("type", "==", type),
            where("detail", "==", detail)
        );

        const querySnapshot = await getDocs(q);

        if (querySnapshot.docs.length > 0) {
            // ÙˆØ¬Ø¯Ù†Ø§ Ù…Ø³ØªÙ†Ø¯ Ù…ÙƒØ±Ø±. Ù†Ø¹ÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£ÙˆÙ„.
            const duplicateDoc = querySnapshot.docs[0].data();
            // Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ù…ÙƒØ±Ø±)
            return {
                fullDateTime: duplicateDoc.fullDateTime,
                type: duplicateDoc.type,
                detail: duplicateDoc.detail,
                amount: duplicateDoc.amount,
                id: querySnapshot.docs[0].id 
            };
        }

        return null; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø±
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù€ Script
    window.saveExpenseToFirestore = saveExpenseToFirestore;
    window.checkDuplicateInFirestore = checkDuplicateInFirestore;
</script>


<script>
    // ------------------------------------------------------------------
    // Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª (JavaScript) Ù„Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
    // ------------------------------------------------------------------

    // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø®ÙŠØ±
    let lastSubmissionType = ''; 

    // 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ù„
    const WORKERS = [
        { value: 'muayyad', text: 'Ù…Ø¤ÙŠØ¯' },
        { value: 'mohammad', text: 'Ù…Ø­Ù…Ø¯ Ø£Ø¨Ùˆ Ø³Ø±ÙŠØ¹Ø©' },
        { value: 'krom', text: 'ÙƒØ±ÙˆÙ…' }
    ];

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ù‡ÙˆØ± (Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±)
    const MONTHS = [
        { value: 'january', text: 'ÙŠÙ†Ø§ÙŠØ±' },
        { value: 'february', text: 'ÙØ¨Ø±Ø§ÙŠØ±' },
        { value: 'march', text: 'Ù…Ø§Ø±Ø³' },
        { value: 'april', text: 'Ø£Ø¨Ø±ÙŠÙ„' },
        { value: 'may', text: 'Ù…Ø§ÙŠÙˆ' },
        { value: 'june', text: 'ÙŠÙˆÙ†ÙŠÙˆ' },
        { value: 'july', text: 'ÙŠÙˆÙ„ÙŠÙˆ' },
        { value: 'august', text: 'Ø£ØºØ³Ø·Ø³' },
        { value: 'september', text: 'Ø³Ø¨ØªÙ…Ø¨Ø±' },
        { value: 'october', text: 'Ø£ÙƒØªÙˆØ¨Ø±' },
        { value: 'november', text: 'Ù†ÙˆÙÙ…Ø¨Ø±' },
        { value: 'december', text: 'Ø¯ÙŠØ³Ù…Ø¨Ø±' }
    ];

    // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ
    const dynamicOptions = {
        'raw_materials': [
            { id: 'oil', text: 'Ø²ÙŠØª 17 Ù„ØªØ±:', unit: 'ØµÙÙŠØ­Ø©' },
            { id: 'flour_halwani', text: 'Ø¯Ù‚ÙŠÙ‚ Ø§Ù„Ø­Ù„ÙˆØ§Ù†ÙŠ:', unit: 'Ø´ÙˆØ§Ù„ (25 ÙƒØ¬Ù…)' },
            { id: 'flour_siga', text: 'Ø¯Ù‚ÙŠÙ‚ Ø³ÙŠÙ‚Ø§ Ø§Ù„Ø£Ø®Ø¶Ø±:', unit: 'Ø¨Ø§ÙƒØª (10 ÙƒØ¬Ù…)' },
            { id: 'flour_normal', text: 'Ø¯Ù‚ÙŠÙ‚ Ø¹Ø§Ø¯ÙŠ:', unit: 'Ø´ÙˆØ§Ù„' },
            { id: 'baking_powder', text: 'Ø¨Ø§ÙƒÙ†Ø¬ Ø¨ÙˆØ¯Ø±:', unit: 'ÙƒÙŠÙ„Ùˆ' },
            { id: 'konafa', text: 'ÙƒÙ†Ø§ÙØ©:', unit: 'ÙƒÙŠÙ„Ùˆ' }
        ],

        'labor_wages': WORKERS, 

        'factory_rent': { type: 'select', options: MONTHS, placeholder: 'Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±' }, 

        'transfer': [
            { value: 'fuel', text: 'Ø¨Ù†Ø²ÙŠÙ†' },
            { value: 'maintenance', text: 'ØµÙŠØ§Ù†Ø©' },
            { value: 'rent', text: 'Ø¥ÙŠØ¬Ø§Ø± ØªØ±Ø­ÙŠÙ„' }
        ],

        'house_expenses': { type: 'text_input', placeholder: 'ØªÙØµÙŠÙ„ Ù†ÙÙ‚Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)' },

        'asset_purchase': { type: 'text_input', placeholder: 'ØªÙØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ (Ù…Ø«Ø§Ù„: Ø´Ø±Ø§Ø¡ Ø®Ù„Ø§Ø· Ø¬Ø¯ÙŠØ¯)' },

        'general_maintenance': { type: 'text_input', placeholder: 'ÙˆØµÙ Ø¹Ù…Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©' },

        // **Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…Ø·Ù„ÙˆØ¨:** Ù…ØµØ±ÙˆÙØ§Øª Ø®Ø§ØµØ© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„
        'special_expenses': { type: 'text_input', placeholder: 'ÙˆØµÙ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø®Ø§Øµ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)' }
    };

    const expenseLimits = { 
        'factory_rent': 150000,
        'electricity_water': 50000,
        'marketing': 30000
    };

    // 2. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ (HH:MM:SS)
    function getCurrentTime() {
        const now = new Date();
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        return `${hour}:${minute}:${second}`; 
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒØ§Ù…Ù„ÙŠÙ† Ù„Ù„Ø­ÙØ¸
    function getFullDateTime(datePart, timePart) {
        return `${datePart} ${timePart}`; 
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµÙŠ Ù„Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
    function updateDisplay() {
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const display = document.getElementById('displayDateTime');

        if (dateInput.value && timeInput.value) {
            display.textContent = `${dateInput.value} - ${timeInput.value}`;
        } else if (dateInput.value) {
            display.textContent = `${dateInput.value} - Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª...`;
        } else {
            // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const today = new Date().toISOString().split('T')[0];
            display.textContent = `${today} ${getCurrentTime().slice(0, 5)}`;
            dateInput.value = today;
            timeInput.value = getCurrentTime().slice(0, 5); // ÙÙ‚Ø· Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ
        }
    }

    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ù†ÙØªØ­ Ø­Ù‚Ù„ Ø§Ù„ÙˆÙ‚Øª
    function handleDateChange(dateValue) {
        document.getElementById('time').style.display = 'block'; // Ù†Ø¸Ù‡Ø± Ø­Ù‚Ù„ Ø§Ù„ÙˆÙ‚Øª
        document.getElementById('time').value = getCurrentTime().slice(0, 5); // Ù†Ø¶Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø³Ø§Ø¹Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø©)
        document.getElementById('time').focus(); 
        updateDisplay();
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø· Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© (YYYY-MM-DD)
    function getDatePart(dateTimeStr) {
        return dateTimeStr.split(' ')[0];
    }

    // 3. Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    function formatNumber(input) {
        let rawValue = input.value.replace(/[^0-9.]/g, ''); 

        const parts = rawValue.split('.');
        if (parts.length > 2) {
            rawValue = parts[0] + '.' + parts.slice(1).join('');
        }

        const rawDigits = rawValue.replace(/,/g, ''); 

        if (isNaN(parseFloat(rawDigits)) || rawDigits.trim() === '') {
            if (input.id === 'amountInput') document.getElementById('amount').value = 0;
            input.value = rawValue;
            return;
        }

        const formatParts = rawDigits.split('.');
        formatParts[0] = formatParts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");

        input.value = formatParts.join('.');

        if (input.id === 'amountInput') {
             document.getElementById('amount').value = parseFloat(rawDigits);
        }

        validateAmountLogic(input);
    }

    // 4. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº (Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø©)
    function validateAmountLogic(input) {
        const amount = parseFloat(document.getElementById('amount').value);
        const type = document.getElementById('expenseType').value;
        const alertDiv = document.getElementById('amountAlert');

        alertDiv.style.display = 'none';
        alertDiv.textContent = '';

        if (amount <= 0) {
            alertDiv.textContent = 'Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.';
            alertDiv.style.display = 'block';
            return;
        }

        if (expenseLimits[type] && amount > expenseLimits[type]) {
            alertDiv.textContent = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ. (${expenseLimits[type].toLocaleString()}).`;
            alertDiv.style.display = 'block';
        }
    }

    // 5. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal)
    function showSuccessModal() {
        const additionalMessageElement = document.getElementById('additionalSuccessMessage');

        additionalMessageElement.textContent = ''; 

        if (lastSubmissionType === 'emergency') {
            additionalMessageElement.textContent = "Ø³ÙŠØªÙ… ØªØ°ÙƒÙŠØ±Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„";
        }

        document.getElementById('successModal').style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        lastSubmissionType = ''; 
    }

    function openEmergencyModal() {
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        document.getElementById('quickAmount').value = '';
        document.getElementById('quickReminder').value = '';
        document.getElementById('quickAmountAlert').style.display = 'none';
        document.getElementById('quickReminderAlert').style.display = 'none';

        document.getElementById('emergencyInputModal').style.display = 'flex';
    }

    // 6. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
    async function checkDuplicate(dateToCompare, type, detail) {
        if (window.checkDuplicateInFirestore) {
             return await window.checkDuplicateInFirestore(dateToCompare, type, detail);
        }
        return null; 
    }

    function showDuplicateDraft(draft) {
        alert(`ØªÙ†Ø¨ÙŠÙ‡ ØªÙƒØ±Ø§Ø±: Ù…ØµØ±ÙˆÙ Ù…Ø´Ø§Ø¨Ù‡ ÙÙŠ ${getDatePart(draft.fullDateTime)}. \nØ§Ù„Ù†ÙˆØ¹: ${draft.type} \nØ§Ù„ØªÙØµÙŠÙ„: ${draft.detail} \nØ§Ù„Ù…Ø¨Ù„Øº: ${draft.amount.toLocaleString()}.`);
    }

    // 7. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
        updateDisplay();
        handleExpenseTypeChange();
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (ÙƒØ§Ø´) Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        selectPaymentMethod('cash', true); 
    });

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
    function updateRawMaterialDisplay() {
        const materialSelect = document.getElementById('expenseDetailMaterial');
        const unitDisplay = document.getElementById('quantityUnitDisplay');
        const selectedOption = materialSelect.options[materialSelect.selectedIndex];

        if (selectedOption && selectedOption.value !== "") {
            unitDisplay.textContent = selectedOption.getAttribute('data-unit');
        } else {
            unitDisplay.textContent = 'Ø§Ù„ÙˆØ­Ø¯Ø©';
        }
    }


    // 8. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù„ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ
    function handleExpenseTypeChange() {
        const typeSelect = document.getElementById('expenseType');
        const detailContainer = document.getElementById('detailFieldContainer');
        const selectedType = typeSelect.value;
        const options = dynamicOptions[selectedType];

        detailContainer.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§ÙˆÙŠØ©

        // **Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ø£Ù… Ù„Ø§**
        const isDetailRequired = (
            selectedType === 'raw_materials' || 
            selectedType === 'labor_wages' ||
            selectedType === 'factory_rent' ||
            selectedType === 'house_expenses' ||
            selectedType === 'asset_purchase' ||
            selectedType === 'general_maintenance' ||
            selectedType === 'special_expenses' // **ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø®Ø§Øµ**
        );

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ø¬Ù…ÙŠØ© (Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©)
        document.querySelector('.form-group[data-group="detail"] label span').style.display = isDetailRequired ? 'inline' : 'none';


        // **Ù…Ù†Ø·Ù‚ Ø®Ø§Øµ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… (Ø­Ù‚Ù„ÙŠÙ†)**
        if (selectedType === 'raw_materials') {

            // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            const select = document.createElement('select');
            select.id = 'expenseDetailMaterial';
            select.name = 'expenseDetailMaterial';
            select.required = true;
            select.style.marginBottom = '10px';
            select.style.width = '100%';
            select.onchange = updateRawMaterialDisplay;

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "-- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø®Ø§Ù… --";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.id;
                option.textContent = opt.text;
                option.setAttribute('data-unit', opt.unit);
                select.appendChild(option);
            });
            detailContainer.appendChild(select);

            // Ø­Ø§ÙˆÙŠØ© Ù„Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
            const quantityWrapper = document.createElement('div');
            quantityWrapper.style.display = 'flex';
            quantityWrapper.style.gap = '10px';

            const inputQuantity = document.createElement('input');
            inputQuantity.type = 'number';
            inputQuantity.id = 'expenseDetailQuantity';
            inputQuantity.name = 'expenseDetailQuantity';
            inputQuantity.placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©';
            inputQuantity.required = true;
            inputQuantity.min = '1';
            inputQuantity.style.flexGrow = '1';

            const unitSpan = document.createElement('span');
            unitSpan.id = 'quantityUnitDisplay';
            unitSpan.textContent = 'Ø§Ù„ÙˆØ­Ø¯Ø©';
            unitSpan.style.padding = '12px 15px';
            unitSpan.style.backgroundColor = '#eee';
            unitSpan.style.borderRadius = '8px';
            unitSpan.style.whiteSpace = 'nowrap';
            unitSpan.style.display = 'flex';
            unitSpan.style.alignItems = 'center';

            quantityWrapper.appendChild(inputQuantity);
            quantityWrapper.appendChild(unitSpan);

            detailContainer.appendChild(quantityWrapper);

            return; // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø¨Ù†Ø§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
        }


        // **Ù…Ù†Ø·Ù‚ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰**
        if (options) {
             if (Array.isArray(options)) {
                // Ø¥Ù†Ø´Ø§Ø¡ Dropdown Ø¹Ø§Ø¯ÙŠ (Ù„Ù€ labor_wages ÙˆØ§Ù„ØªØ±Ø­ÙŠÙ„)
                const select = document.createElement('select');
                select.id = 'expenseDetail';
                select.name = 'expenseDetail';
                select.required = isDetailRequired;

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "-- Ø§Ø®ØªØ± ØªÙØµÙŠÙ„Ø§Ù‹ --";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    select.appendChild(option);
                });

                detailContainer.appendChild(select);

            } else if (options.type === 'select') {
                 // Ø¥Ù†Ø´Ø§Ø¡ Dropdown (Ù…Ø«Ù„ Ø´Ù‡ÙˆØ± Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±)
                const select = document.createElement('select');
                select.id = 'expenseDetail';
                select.name = 'expenseDetail';
                select.required = isDetailRequired;

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = options.placeholder;
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                options.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    select.appendChild(option);
                });

                detailContainer.appendChild(select);

            } else if (options.type === 'text_input') {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚Ù„ Ù†Øµ Ø­Ø± (Ù„Ù€ house_expensesØŒ asset_purchaseØŒ special_expenses Ø¥Ù„Ø®)
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'expenseDetailText';
                input.name = 'expenseDetailText';
                input.placeholder = options.placeholder;
                input.required = isDetailRequired; // **ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ù‡Ù†Ø§**

                detailContainer.appendChild(input);
            }
        }
    }


    // 9. Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    document.getElementById('expenseForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        if (!document.getElementById('date').value || !document.getElementById('time').value) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª.");
            return;
        }

        // 1. Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙØµÙŠÙ„ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
        const datePart = document.getElementById('date').value;
        const timePart = document.getElementById('time').value + ':00'; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
        const fullSaveDateTime = getFullDateTime(datePart, timePart);

        const type = document.getElementById('expenseType').value;
        const amount = parseFloat(document.getElementById('amount').value); 
        const paymentMethod = document.getElementById('paymentMethod').value; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
        const notes = document.getElementById('notes').value;

        let detailValue;

        // **Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„ØªØ­Ø¯ÙŠØ¯ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙØµÙŠÙ„**
        if (type === 'raw_materials') {
            const material = document.getElementById('expenseDetailMaterial').options[document.getElementById('expenseDetailMaterial').selectedIndex].textContent;
            const quantity = document.getElementById('expenseDetailQuantity').value;
            const unit = document.getElementById('quantityUnitDisplay').textContent;
            detailValue = `${material} - Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity} ${unit}`;
        } else if (document.getElementById('expenseDetailText')) {
            detailValue = document.getElementById('expenseDetailText').value;
        } else if (document.getElementById('expenseDetail')) {
            detailValue = document.getElementById('expenseDetail').options[document.getElementById('expenseDetail').selectedIndex].textContent;
        } else {
            detailValue = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        // **Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„ØªÙØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ**
        // Ù‡Ø°Ø§ ÙŠØºØ·ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙƒÙˆÙ† ÙÙŠÙ‡Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø³Ø¯Ù„ Ù‡Ùˆ "Ø§Ø®ØªØ± ØªÙØµÙŠÙ„Ø§Ù‹"
        if (type !== 'raw_materials' && document.querySelector('.form-group[data-group="detail"] label span').style.display !== 'none' && (detailValue === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' || detailValue.trim() === '-- Ø§Ø®ØªØ± ØªÙØµÙŠÙ„Ø§Ù‹ --' || detailValue.trim() === 'ÙˆØµÙ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø®Ø§Øµ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)')) {
            alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªÙØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
            return;
        }

        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Firestore
        document.getElementById('typeAlert').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
        const duplicateDraft = await checkDuplicate(fullSaveDateTime, type, detailValue); 

        if (duplicateDraft) {
            document.getElementById('typeAlert').innerHTML = `
                Ù„Ù‚Ø¯ Ø£Ø¯Ø®Ù„Øª Ù…ØµØ±ÙˆÙØ§Ù‹ Ù…Ø´Ø§Ø¨Ù‡Ø§Ù‹ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…! 
                <button type="button" class="btn" style="background-color:#ffc107; color:#333; margin-right: 10px; font-size:0.9em;" onclick="showDuplicateDraft(${JSON.stringify(duplicateDraft).replace(/"/g, `'`)})">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø©</button>
            `;
            document.getElementById('typeAlert').style.display = 'block';
            return; 
        }

        // 3. Ø¨Ù†Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ Ù„Ù„Ø­ÙØ¸
        const expenseToSave = {
            datePart: datePart, // Ù„Ø­Ø§Ø¬ØªÙ†Ø§ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
            fullDateTime: fullSaveDateTime,
            type: type,
            detail: detailValue,
            amount: amount,
            paymentMethod: paymentMethod,
            notes: notes
        };

        // 4. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firestore ÙˆØ¥Ø¸Ù‡Ø§Ø± Modal Ø§Ù„Ù†Ø¬Ø§Ø­
        const saveSuccessful = await window.saveExpenseToFirestore(expenseToSave);

        if (saveSuccessful) {
            lastSubmissionType = 'normal'; // ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            showSuccessModal(); 

            // Ø¥ÙØ±Ø§Øº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
            this.reset();
            updateDisplay();
            document.getElementById('time').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            document.getElementById('amountInput').value = '';
            handleExpenseTypeChange(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ØªÙØµÙŠÙ„
        } else {
             // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø³ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø¯Ø§Ù„Ø© saveExpenseToFirestore
        }
    });


    // 10. Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø·Ø§Ø±Ø¦ Ø§Ù„Ø³Ø±ÙŠØ¹
    document.getElementById('quickEmergencyForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const rawAmount = document.getElementById('quickAmount').value.replace(/,/g, '');
        const amountToSave = (rawAmount === "" || isNaN(parseFloat(rawAmount))) ? 0 : parseFloat(rawAmount);

        const datePart = new Date().toISOString().split('T')[0];
        const timePart = getCurrentTime();
        const fullSaveDateTime = getFullDateTime(datePart, timePart); 

        const type = 'emergency';
        const detailValue = document.getElementById('quickReminder').value.trim();

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Firestore
        document.getElementById('quickReminderAlert').style.display = 'none';
        const duplicateDraft = await checkDuplicate(fullSaveDateTime, type, detailValue);

        if (duplicateDraft) {
             document.getElementById('quickReminderAlert').innerHTML = `
                Ù„Ù‚Ø¯ Ø£Ø¯Ø®Ù„Øª Ù…ØµØ±ÙˆÙØ§Ù‹ Ø·Ø§Ø±Ø¦Ø§Ù‹ Ù…Ø´Ø§Ø¨Ù‡Ø§Ù‹ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…! 
                <button type="button" class="btn" style="background-color:#ffc107; color:#333; margin-right: 10px; font-size:0.9em;" onclick="showDuplicateDraft(${JSON.stringify(duplicateDraft).replace(/"/g, `'`)})">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø©</button>
            `;
            document.getElementById('quickReminderAlert').style.display = 'block';
            return;
        }

        // Ø¨Ù†Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø·Ø§Ø±Ø¦
        const emergencyExpenseToSave = {
            datePart: datePart,
            fullDateTime: fullSaveDateTime,
            type: type,
            detail: detailValue,
            amount: amountToSave,
            paymentMethod: 'undefined', // Ù„Ù†Ù…ÙŠØ²Ù‡ ÙƒØ¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹
            notes: 'Ù…ØµØ±ÙˆÙ Ø·Ø§Ø±Ø¦/Ø³Ø±ÙŠØ¹'
        };

        // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firestore ÙˆØ¥Ø¸Ù‡Ø§Ø± Modal Ø§Ù„Ù†Ø¬Ø§Ø­
        const saveSuccessful = await window.saveExpenseToFirestore(emergencyExpenseToSave);

        if (saveSuccessful) {
            lastSubmissionType = 'emergency'; // ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            showSuccessModal();
            closeModal('emergencyInputModal');

            this.reset();
        }
    });

    // ------------------------------------------------------------------
    // ğŸŒŸ Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸŒŸ
    // ------------------------------------------------------------------
    function selectPaymentMethod(method, isInitialLoad = false) {
        const bankakOption = document.getElementById('bankakOption');
        const cashOption = document.getElementById('cashOption');
        const hiddenField = document.getElementById('paymentMethod');

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙƒÙ„
        bankakOption.classList.remove('active');
        cashOption.classList.remove('active');
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
        if (method === 'bankak') {
            bankakOption.classList.add('active');
            hiddenField.value = 'bankak';
        } else if (method === 'cash') {
            cashOption.classList.add('active');
            hiddenField.value = 'cash';
        }

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª)
        if (!isInitialLoad) {
             document.getElementById('typeAlert').style.display = 'none';
        }
    }
</script>

</body>
</html>
