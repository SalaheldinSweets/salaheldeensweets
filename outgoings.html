<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª - ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø©</title>
    <style>
        /* 1. Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø¬Ù…Ø§Ù„ÙŠØ© */
        :root {
            --primary-color: #4CAF50; /* Ø£Ø®Ø¶Ø± Ù…Ø±ÙŠØ­ */
            --secondary-color: #007bff;
            --danger-color: #d9534f;
            --bg-light: #f9f9f9;
            --surface-color: #ffffff;
            --border-radius: 12px;
            --input-radius: 8px;
        }

        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        .page-header {
            width: 100%;
            max-width: 550px;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        .page-header h1 {
            margin: 0;
            font-size: 1.8em;
            color: #333;
            font-weight: 700;
        }

        .emergency-button {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
        }
        .emergency-button:hover {
            background-color: #c9302c;
        }

        .expense-form-container {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 550px; 
            margin-bottom: 25px;
            border: 1px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: var(--input-radius);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
            outline: none;
        }

        .datetime-input-wrapper {
            position: relative;
            background-color: #f7f7f7;
            border-radius: var(--input-radius);
            padding: 12px 15px;
            display: flex;
            align-items: center;
            border: 1px solid #e0e0e0;
            cursor: pointer;
        }
        .datetime-input-wrapper:hover {
            background-color: #eeeeee;
        }

        .datetime-input-wrapper input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--input-radius);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }

        .btn-save {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        .btn-save:hover {
            background-color: #43a047;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); 
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 40px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 350px;
        }
        .checkmark-circle {
            width: 80px;
            height: 80px;
            position: relative;
            margin: 0 auto 20px;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: scaleIn 0.5s ease-in-out;
        }
        .checkmark {
            width: 40px;
            height: 20px;
            border: 4px solid var(--primary-color);
            border-top: none;
            border-right: none;
            transform: rotate(-45deg);
            opacity: 0;
            animation: checkmarkDraw 0.5s ease-in-out 0.5s forwards;
        }
        @keyframes scaleIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes checkmarkDraw { 0% { width: 0; height: 0; opacity: 1; } 50% { width: 40px; height: 0; opacity: 1; } 100% { width: 40px; height: 20px; opacity: 1; } }

    </style>
</head>
<body>

<div class="page-header">
    <button class="emergency-button" onclick="openEmergencyModal()" title="Ù…ØµØ±ÙˆÙ Ø·Ø§Ø±Ø¦">
        ğŸš¨
    </button>
    <h1>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h1>
</div>

<div id="successModal" class="modal">
    <div class="modal-content">
        <div class="checkmark-circle">
            <div class="checkmark"></div>
        </div>
        <h3>ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!</h3>
        <p>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….</p>
        <p id="additionalSuccessMessage" style="color: #ff9800; font-weight: 600;"></p>
        <button onclick="closeModal('successModal')" class="btn btn-save" style="margin-top: 15px;">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
</div>

<div id="emergencyInputModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal('emergencyInputModal')" style="float:left; cursor:pointer; font-size:1.5em; color:#888;">&times;</span>
        <h3 style="color:var(--danger-color);">Ø¥Ø¯Ø®Ø§Ù„ Ø·Ø§Ø±Ø¦</h3>
        <form id="quickEmergencyForm">

            <div class="form-group">
                <label for="quickAmount">Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <input type="tel" id="quickAmount" name="quickAmount" placeholder="0.00" oninput="formatNumber(this)">
                <span class="amount-unit">Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ</span>
                <div class="alert-message" id="quickAmountAlert"></div>
            </div>

            <div class="form-group">
                <label for="quickReminder">Ù…Ù„Ø§Ø­Ø¸Ø©/ØªØ°ÙƒÙŠØ±: <span style="color:red;">*</span></label>
                <textarea id="quickReminder" name="quickReminder" rows="2" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)" required></textarea>
                <div class="alert-message" id="quickReminderAlert"></div>
            </div>

            <div class="actions" style="justify-content: flex-end;">
                <button type="submit" class="btn" style="background-color: var(--danger-color);">ğŸ’¾ Ø­ÙØ¸ Ø³Ø±ÙŠØ¹</button>
            </div>
        </form>
    </div>
</div>


<div class="expense-form-container main-container">
    <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h2>

    <form id="expenseForm">

        <div class="form-group" data-group="datetime">
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª:</label>
            <div class="datetime-input-wrapper" onclick="document.getElementById('date').click()">
                <span id="displayDateTime">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠÙŠÙ†</span>

                <input type="date" id="date" name="date" required onchange="handleDateChange(this.value)" style="display:none;">
                <input type="time" id="time" name="time" step="1" required style="display:none;" onchange="updateDisplay()">
            </div>
        </div>


        <div class="form-group" data-group="type">
            <label for="expenseType">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ: <span style="color:red;">*</span></label>
            <select id="expenseType" name="expenseType" required onchange="handleExpenseTypeChange()">
                <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù†ÙˆØ¹Ø§Ù‹ --</option>
                <option value="raw_materials">ğŸ“¦ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</option>
                <option value="labor_wages">ğŸ‘· Ø£Ø¬ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„</option>
                <option value="factory_rent">ğŸ  Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ØµÙ†Ø¹</option>
                <option value="electricity_water">âš¡ï¸ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ù…ÙŠØ§Ù‡</option>
                <option value="general_maintenance">ğŸ› ï¸ ØµÙŠØ§Ù†Ø© Ø¹Ø§Ù…Ø©</option>
                <option value="marketing">ğŸ“¢ ØªØ³ÙˆÙŠÙ‚</option>
                <option value="transfer">ğŸšš Ø§Ù„ØªØ±Ø­ÙŠÙ„</option>
                <option value="house_expenses">ğŸ¡ Ø§Ù„Ù…Ù†Ø²Ù„ (Ù†ÙÙ‚Ø§Øª)</option>
                <option value="asset_purchase">ğŸ’ Ø´Ø±Ø§Ø¡ Ø£ØµÙˆÙ„ (Ø¥Ø³ØªØ«Ù…Ø§Ø±)</option>
            </select>
            <div class="alert-message" id="typeAlert"></div>
        </div>

        <div class="form-group" data-group="detail">
            <label for="expenseDetail">ØªÙØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ: <span style="color:red;">*</span></label>
            <div id="detailFieldContainer" class="dynamic-field-container">
                </div>
            <div class="alert-message" id="detailAlert"></div>
        </div>

        <div class="form-group" data-group="amount">
            <label for="amountInput">Ø§Ù„Ù…Ø¨Ù„Øº: <span style="color:red;">*</span></label>
            <input type="tel" id="amountInput" name="amountInput" value="" placeholder="0.00" required oninput="formatNumber(this); validateAmountLogic(this)">
            <input type="hidden" id="amount" name="amount" value="0"> <span class="amount-unit">Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ</span>
            <div class="alert-message" id="amountAlert"></div>
        </div>

        <div class="form-group" data-group="payment">
            <label for="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
            <select id="paymentMethod" name="paymentMethod">
                <option value="cash" selected>Ù†Ù‚Ø¯ (ÙƒØ§Ø´)</option>
                <option value="bankak">Ø¨Ù†ÙƒÙƒ</option>
            </select>
        </div>

        <div class="form-group" data-group="notes">
            <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ"></textarea>
        </div>

        <div class="actions" style="justify-content: flex-end;">
            <button type="submit" class="btn btn-save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        </div>

    </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø®Ø§ØµØ©
    const firebaseConfig = {
        apiKey: "AIzaSyDZCydTHThyMEMv_x261_HhJB_wZNUr7JA",
        authDomain: "salahsweetgedo.firebaseapp.com",
        projectId: "salahsweetgedo",
        storageBucket: "salahsweetgedo.firebasestorage.app",
        messagingSenderId: "1079672977254",
        appId: "1:1079672977254:web:7e901bb6d55b71c716baa7",
        measurementId: "G-3Y9LT7JXY0"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const app = firebase.initializeApp(firebaseConfig);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firestore
    const db = app.firestore();

    // Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Collection) Ø§Ù„Ø°ÙŠ Ø³ØªÙØ­ÙØ¸ ÙÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    const EXPENSES_COLLECTION = "expenses"; 

    // ------------------------------------------------------------------
    // Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª (JavaScript) Ù„Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
    // ------------------------------------------------------------------

    // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø®ÙŠØ± (Ø¬Ø¯ÙŠØ¯)
    let lastSubmissionType = ''; 

    // 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
    const WORKERS = [
        { value: 'muayyad', text: 'Ù…Ø¤ÙŠØ¯' },
        { value: 'mohammad', text: 'Ù…Ø­Ù…Ø¯ Ø£Ø¨Ùˆ Ø³Ø±ÙŠØ¹Ø©' },
        { value: 'krom', text: 'ÙƒØ±ÙˆÙ…' }
    ];

    const MONTHS = [
        { value: 'january', text: 'ÙŠÙ†Ø§ÙŠØ±' },
        { value: 'february', text: 'ÙØ¨Ø±Ø§ÙŠØ±' },
        { value: 'march', text: 'Ù…Ø§Ø±Ø³' },
        { value: 'april', text: 'Ø£Ø¨Ø±ÙŠÙ„' },
        { value: 'may', text: 'Ù…Ø§ÙŠÙˆ' },
        { value: 'june', text: 'ÙŠÙˆÙ†ÙŠÙˆ' },
        { value: 'july', text: 'ÙŠÙˆÙ„ÙŠÙˆ' },
        { value: 'august', text: 'Ø£ØºØ³Ø·Ø³' },
        { value: 'september', text: 'Ø³Ø¨ØªÙ…Ø¨Ø±' },
        { value: 'october', text: 'Ø£ÙƒØªÙˆØ¨Ø±' },
        { value: 'november', text: 'Ù†ÙˆÙÙ…Ø¨Ø±' },
        { value: 'december', text: 'Ø¯ÙŠØ³Ù…Ø¨Ø±' }
    ];

    const dynamicOptions = {
        'raw_materials': [
            { id: 'oil', text: 'Ø²ÙŠØª 17 Ù„ØªØ±:', unit: 'ØµÙÙŠØ­Ø©' },
            { id: 'flour_halwani', text: 'Ø¯Ù‚ÙŠÙ‚ Ø§Ù„Ø­Ù„ÙˆØ§Ù†ÙŠ:', unit: 'Ø´ÙˆØ§Ù„ (25 ÙƒØ¬Ù…)' },
            { id: 'flour_siga', text: 'Ø¯Ù‚ÙŠÙ‚ Ø³ÙŠÙ‚Ø§ Ø§Ù„Ø£Ø®Ø¶Ø±:', unit: 'Ø¨Ø§ÙƒØª (10 ÙƒØ¬Ù…)' },
            { id: 'flour_normal', text: 'Ø¯Ù‚ÙŠÙ‚ Ø¹Ø§Ø¯ÙŠ:', unit: 'Ø´ÙˆØ§Ù„' },
            { id: 'baking_powder', text: 'Ø¨Ø§ÙƒÙ†Ø¬ Ø¨ÙˆØ¯Ø±:', unit: 'ÙƒÙŠÙ„Ùˆ' },
            { id: 'konafa', text: 'ÙƒÙ†Ø§ÙØ©:', unit: 'ÙƒÙŠÙ„Ùˆ' }
        ],
        'labor_wages': WORKERS, 
        'factory_rent': { type: 'select', options: MONTHS, placeholder: 'Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±' }, 
        'transfer': [
            { value: 'fuel', text: 'Ø¨Ù†Ø²ÙŠÙ†' },
            { value: 'maintenance', text: 'ØµÙŠØ§Ù†Ø©' },
            { value: 'rent', text: 'Ø¥ÙŠØ¬Ø§Ø± ØªØ±Ø­ÙŠÙ„' }
        ],
        'house_expenses': { type: 'text_input', placeholder: 'ØªÙØµÙŠÙ„ Ù†ÙÙ‚Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)' },
        'asset_purchase': { type: 'text_input', placeholder: 'ØªÙØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ (Ù…Ø«Ø§Ù„: Ø´Ø±Ø§Ø¡ Ø®Ù„Ø§Ø· Ø¬Ø¯ÙŠØ¯)' },
        'general_maintenance': { type: 'text_input', placeholder: 'ÙˆØµÙ Ø¹Ù…Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©' },
        'electricity_water': { type: 'text_input', placeholder: 'ØªÙØ§ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ù…ÙŠØ§Ù‡' }, // ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ù†ØµÙŠ Ù„Ù‡Ø§ 
        'marketing': { type: 'text_input', placeholder: 'ØªÙØ§ØµÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø§Ù„ØªØ³ÙˆÙŠÙ‚' },
        'special_expenses': { type: 'text_input', placeholder: 'ÙˆØµÙ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø®Ø§Øµ' }
    };

    const expenseLimits = { 
        'factory_rent': 150000,
        'electricity_water': 50000,
        'marketing': 30000
    };

    // ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµÙÙˆÙØ© draftExpenses Ù„Ø£Ù†Ù†Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Firestore Ø§Ù„Ø¢Ù†

    // 2. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
    function getCurrentTime() {
        const now = new Date();
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        return `${hour}:${minute}:${second}`; 
    }

    function getFullDateTime(datePart, timePart) {
        return `${datePart} ${timePart}`; 
    }

    function updateDisplay() {
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const display = document.getElementById('displayDateTime');

        if (dateInput.value && timeInput.value) {
            display.textContent = `${dateInput.value} - ${timeInput.value}`;
        } else if (dateInput.value) {
            display.textContent = `${dateInput.value} - Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª...`;
        } else {
            const today = new Date().toISOString().split('T')[0];
            display.textContent = `${today} ${getCurrentTime().slice(0, 5)}`;
            dateInput.value = today;
            timeInput.value = getCurrentTime().slice(0, 5); 
        }
    }

    function handleDateChange(dateValue) {
        document.getElementById('time').style.display = 'block'; 
        document.getElementById('time').value = getCurrentTime().slice(0, 5);
        document.getElementById('time').focus(); 
        updateDisplay();
    }

    // 3. Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    function formatNumber(input) {
        let rawValue = input.value.replace(/[^0-9.]/g, ''); 
        const parts = rawValue.split('.');
        if (parts.length > 2) {
            rawValue = parts[0] + '.' + parts.slice(1).join('');
        }

        const rawDigits = rawValue.replace(/,/g, ''); 

        if (isNaN(parseFloat(rawDigits)) || rawDigits.trim() === '') {
            if (input.id === 'amountInput') document.getElementById('amount').value = 0;
            input.value = rawValue;
            return;
        }

        const formatParts = rawDigits.split('.');
        formatParts[0] = formatParts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = formatParts.join('.');

        if (input.id === 'amountInput') {
             document.getElementById('amount').value = parseFloat(rawDigits);
        }

        validateAmountLogic(input);
    }

    // 4. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº
    function validateAmountLogic(input) {
        const amount = parseFloat(document.getElementById('amount').value);
        const type = document.getElementById('expenseType').value;
        const alertDiv = document.getElementById('amountAlert');

        alertDiv.style.display = 'none';
        alertDiv.textContent = '';

        if (amount <= 0 && type !== 'emergency') { // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø·Ø§Ø±Ø¦ Ù…Ù† Ø§Ù„ØªØ­Ù‚Ù‚ > 0 
            alertDiv.textContent = 'Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ± Ù„Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¹Ø§Ø¯ÙŠ.';
            alertDiv.style.display = 'block';
            return;
        }

        if (expenseLimits[type] && amount > expenseLimits[type]) {
            alertDiv.textContent = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ. (${expenseLimits[type].toLocaleString()}).`;
            alertDiv.style.display = 'block';
        }
    }

    // 5. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal)
    function showSuccessModal() {
        const additionalMessageElement = document.getElementById('additionalSuccessMessage');
        additionalMessageElement.textContent = ''; 
        if (lastSubmissionType === 'emergency') {
            additionalMessageElement.textContent = "Ø³ÙŠØªÙ… ØªØ°ÙƒÙŠØ±Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„";
        }
        document.getElementById('successModal').style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        lastSubmissionType = '';
    }

    function openEmergencyModal() {
        document.getElementById('quickAmount').value = '';
        document.getElementById('quickReminder').value = '';
        document.getElementById('quickAmountAlert').style.display = 'none';
        document.getElementById('quickReminderAlert').style.display = 'none';
        document.getElementById('emergencyInputModal').style.display = 'flex';
    }

    // 7. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
        updateDisplay();
        handleExpenseTypeChange();
    });

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
    function updateRawMaterialDisplay() {
        const materialSelect = document.getElementById('expenseDetailMaterial');
        const unitDisplay = document.getElementById('quantityUnitDisplay');
        const selectedOption = materialSelect.options[materialSelect.selectedIndex];

        if (selectedOption && selectedOption.value !== "") {
            unitDisplay.textContent = selectedOption.getAttribute('data-unit');
        } else {
            unitDisplay.textContent = 'Ø§Ù„ÙˆØ­Ø¯Ø©';
        }
    }


    // 8. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù„ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ (Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„ØªØ¹Ø¯ÙŠÙ„)
    function handleExpenseTypeChange() {
        const typeSelect = document.getElementById('expenseType');
        const detailContainer = document.getElementById('detailFieldContainer');
        const selectedType = typeSelect.value;
        const options = dynamicOptions[selectedType];

        detailContainer.innerHTML = ''; 

        if (selectedType === 'raw_materials') {

            const select = document.createElement('select');
            select.id = 'expenseDetailMaterial';
            select.name = 'expenseDetailMaterial';
            select.required = true;
            select.style.marginBottom = '10px';
            select.style.width = '100%';
            select.onchange = updateRawMaterialDisplay;

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "-- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø®Ø§Ù… --";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.id;
                option.textContent = opt.text;
                option.setAttribute('data-unit', opt.unit);
                select.appendChild(option);
            });
            detailContainer.appendChild(select);

            const quantityWrapper = document.createElement('div');
            quantityWrapper.style.display = 'flex';
            quantityWrapper.style.gap = '10px';

            const inputQuantity = document.createElement('input');
            inputQuantity.type = 'number';
            inputQuantity.id = 'expenseDetailQuantity';
            inputQuantity.name = 'expenseDetailQuantity';
            inputQuantity.placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©';
            inputQuantity.required = true;
            inputQuantity.min = '1';
            inputQuantity.style.flexGrow = '1';

            const unitSpan = document.createElement('span');
            unitSpan.id = 'quantityUnitDisplay';
            unitSpan.textContent = 'Ø§Ù„ÙˆØ­Ø¯Ø©';
            unitSpan.style.padding = '12px 15px';
            unitSpan.style.backgroundColor = '#eee';
            unitSpan.style.borderRadius = '8px';
            unitSpan.style.whiteSpace = 'nowrap';
            unitSpan.style.display = 'flex';
            unitSpan.style.alignItems = 'center';

            quantityWrapper.appendChild(inputQuantity);
            quantityWrapper.appendChild(unitSpan);

            detailContainer.appendChild(quantityWrapper);

            return; 
        }

        if (options) {
             if (Array.isArray(options)) {
                const select = document.createElement('select');
                select.id = 'expenseDetail';
                select.name = 'expenseDetail';
                select.required = true;

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "-- Ø§Ø®ØªØ± ØªÙØµÙŠÙ„Ø§Ù‹ --";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    select.appendChild(option);
                });

                detailContainer.appendChild(select);

            } else if (options.type === 'select') {
                const select = document.createElement('select');
                select.id = 'expenseDetail';
                select.name = 'expenseDetail';
                select.required = true;

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = options.placeholder;
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                options.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    select.appendChild(option);
                });

                detailContainer.appendChild(select);

            } else if (options.type === 'text_input') {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'expenseDetailText';
                input.name = 'expenseDetailText';
                input.placeholder = options.placeholder;
                input.required = true;

                detailContainer.appendChild(input);
            }
        }
    }


    // 9. Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø§Ù„Ù…Ø­Ø¯Ø« Ù„Ù€ Firestore)
    document.getElementById('expenseForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!document.getElementById('date').value || !document.getElementById('time').value) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª.");
            return;
        }

        const datePart = document.getElementById('date').value;
        const timePart = document.getElementById('time').value + ':00';
        const fullSaveDateTime = getFullDateTime(datePart, timePart);

        const type = document.getElementById('expenseType').value;
        const amount = parseFloat(document.getElementById('amount').value); 
        const paymentMethod = document.getElementById('paymentMethod').value;
        const notes = document.getElementById('notes').value;

        let detailValue;

        if (type === 'raw_materials') {
            const material = document.getElementById('expenseDetailMaterial').options[document.getElementById('expenseDetailMaterial').selectedIndex].textContent;
            const quantity = document.getElementById('expenseDetailQuantity').value;
            const unit = document.getElementById('quantityUnitDisplay').textContent;
            detailValue = `${material} - Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity} ${unit}`;
        } else if (document.getElementById('expenseDetailText')) {
            detailValue = document.getElementById('expenseDetailText').value;
        } else if (document.getElementById('expenseDetail')) {
            detailValue = document.getElementById('expenseDetail').options[document.getElementById('expenseDetail').selectedIndex].textContent;
        } else {
            detailValue = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        const expenseData = { 
            fullDateTime: fullSaveDateTime, 
            date: datePart,
            type: type, 
            detail: detailValue, 
            amount: amount,
            paymentMethod: paymentMethod,
            notes: notes,
            isEmergency: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // **4. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firestore**
        try {
            await db.collection(EXPENSES_COLLECTION).add(expenseData);
            
            lastSubmissionType = 'normal';
            showSuccessModal(); 

            // 5. Ø¥ÙØ±Ø§Øº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
            this.reset();
            updateDisplay();
            document.getElementById('time').style.display = 'none';
            document.getElementById('amountInput').value = '';
            handleExpenseTypeChange();

        } catch (error) {
            console.error("Error adding document: ", error);
            alert("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore.");
        }
    });


    // 10. Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø·Ø§Ø±Ø¦ Ø§Ù„Ø³Ø±ÙŠØ¹ (Ø§Ù„Ù…Ø­Ø¯Ø« Ù„Ù€ Firestore)
    document.getElementById('quickEmergencyForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const rawAmount = document.getElementById('quickAmount').value.replace(/,/g, '');
        const amountToSave = (rawAmount === "" || isNaN(parseFloat(rawAmount))) ? 0 : parseFloat(rawAmount);

        const detailValue = document.getElementById('quickReminder').value.trim();

        if (detailValue === "") {
            document.getElementById('quickReminderAlert').textContent = 'ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø©/ØªØ°ÙƒÙŠØ± Ø¥Ø¬Ø¨Ø§Ø±ÙŠ.';
            document.getElementById('quickReminderAlert').style.display = 'block';
            return;
        }
        document.getElementById('quickReminderAlert').style.display = 'none';


        const datePart = new Date().toISOString().split('T
