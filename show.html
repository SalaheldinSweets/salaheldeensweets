<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª - ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ù†ÙŠÙ‚Ø© (Ø¨Ø¯ÙˆÙ† ÙÙ‡Ø§Ø±Ø³ Ù…Ø±ÙƒØ¨Ø©)</title>
    <style>
        /* 1. Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø¬Ù…Ø§Ù„ÙŠØ© */
        :root {
            --primary-color: #007bff;
            --secondary-color: #4CAF50;
            --danger-color: #d9534f;
            --text-color: #333;
            --bg-light: #f4f7f6;
            --surface-color: #ffffff;
            --border-radius: 12px;
            --input-radius: 8px;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-color);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ */
        .page-header {
            width: 100%;
            max-width: 900px;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        .page-header h1 {
            margin: 0;
            font-size: 2em;
            color: var(--primary-color);
            font-weight: 800;
        }

        /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©/Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
        .action-button {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--input-radius);
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
        }
        .action-button:hover {
            background-color: #43a047;
        }

        /* Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) */
        .summary-card {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 900px;
            margin-bottom: 25px;
            text-align: center;
            border-right: 5px solid var(--primary-color);
        }
        .summary-card h2 {
            margin-top: 0;
            font-size: 1.2em;
            color: #555;
            font-weight: 700;
        }
        .summary-card p {
            font-size: 2.2em;
            font-weight: 800;
            color: var(--danger-color);
            margin: 5px 0 0;
        }


        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„ØªØ¬Ù…ÙŠØ¹) */
        .tools-container {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 900px; 
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between;
        }
        
        .tools-container select, .tools-container input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--input-radius);
            font-size: 1em;
            flex-grow: 1;
            min-width: 150px;
            background-color: #fcfcfc;
        }
        
        .btn-filter {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            padding: 10px 15px;
            border: none;
            border-radius: var(--input-radius);
        }
        .btn-filter:hover {
            background-color: #0056b3;
        }

        /* 2. Ø£Ù†Ù…Ø§Ø· Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª */
        .expenses-list-container {
            width: 100%;
            max-width: 900px;
            margin-top: 10px;
        }

        /* Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ) */
        .group-card {
            margin-bottom: 25px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 15px 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .group-header h3 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .group-total {
            font-size: 1.2em;
            font-weight: 800;
            color: var(--danger-color);
        }

        /* Ø¹Ù†ØµØ± Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙˆØ§Ø­Ø¯ (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª) */
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-top: 10px;
            background-color: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .expense-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.08);
        }

        .expense-details {
            flex-grow: 1;
        }

        .expense-details strong {
            display: block;
            font-size: 1em;
            color: var(--text-color);
            font-weight: 600;
        }

        .expense-meta {
            font-size: 0.85em;
            color: #888;
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
        }
        .expense-meta span {
            margin-left: 15px;
        }

        .expense-amount {
            font-size: 1.3em;
            font-weight: 800;
            color: var(--danger-color);
            white-space: nowrap;
        }
        
        /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø© (ØªØ­Ù…ÙŠÙ„ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª) */
        .status-message {
            text-align: center;
            padding: 40px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-top: 20px;
            color: #555;
            font-weight: 600;
            font-size: 1.1em;
        }

    </style>
</head>
<body>

<div class="page-header">
    <button class="action-button" onclick="window.location.href='index.html'" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„">
        â•
    </button>
    <h1>Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h1>
</div>

<div id="summaryCard" class="summary-card" style="display:none;">
    <h2 id="totalSummaryTitle">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙƒÙ„ÙŠØ©</h2>
    <p id="totalSummaryAmount">0.00 Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ</p>
</div>


<div class="tools-container">
    
    <select id="groupBy" onchange="loadExpenses()" style="flex-grow: 1; min-width: 180px;">
        <option value="datePart" selected>ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
        <option value="type">ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</option>
        <option value="none">Ø¹Ø±Ø¶ Ø¹Ø§Ù… (Ø¨Ø¯ÙˆÙ† ØªØ¬Ù…ÙŠØ¹)</option>
    </select>
    
    <select id="filterType" onchange="loadExpenses()" style="flex-grow: 1; min-width: 180px;">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
        <option value="raw_materials">ğŸ“¦ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</option>
        <option value="labor_wages">ğŸ‘· Ø£Ø¬ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„</option>
        <option value="factory_rent">ğŸ  Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ØµÙ†Ø¹</option>
        <option value="electricity_water">âš¡ï¸ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ù…ÙŠØ§Ù‡</option>
        <option value="general_maintenance">ğŸ› ï¸ ØµÙŠØ§Ù†Ø© Ø¹Ø§Ù…Ø©</option>
        <option value="marketing">ğŸ“¢ ØªØ³ÙˆÙŠÙ‚</option>
        <option value="transfer">ğŸšš Ø§Ù„ØªØ±Ø­ÙŠÙ„</option>
        <option value="house_expenses">ğŸ¡ Ø§Ù„Ù…Ù†Ø²Ù„ (Ù†ÙÙ‚Ø§Øª)</option>
        <option value="asset_purchase">ğŸ’ Ø´Ø±Ø§Ø¡ Ø£ØµÙˆÙ„ (Ø¥Ø³ØªØ«Ù…Ø§Ø±)</option>
        <option value="emergency">ğŸš¨ Ø·Ø§Ø±Ø¦/Ø³Ø±ÙŠØ¹</option>
    </select>
    
    <input type="date" id="filterDateStart" onchange="loadExpenses()">
    <input type="date" id="filterDateEnd" onchange="loadExpenses()">
    
    <button class="btn-filter" onclick="resetFilters()">
        ğŸ”„ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
    </button>
</div>


<div class="expenses-list-container">
    <div id="statusMessage" class="status-message">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª... â³</div>
    <div id="expensesList">
        </div>
</div>

<script type="module">
    // ------------------------------------------------------------------
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ±Ø¨Ø· Firebase
    // ------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    // Your web app's Firebase configuration (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù…Ù„Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„)
    const firebaseConfig = {
      apiKey: "AIzaSyDZCydTHThyMEMv_x261_HhJB_wZNUr7JA",
      authDomain: "salahsweetgedo.firebaseapp.com",
      projectId: "salahsweetgedo",
      storageBucket: "salahsweetgedo.firebasestorage.app",
      messagingSenderId: "1079672977254",
      appId: "1:1079672977254:web:7e901bb6d55b71c716baa7",
      measurementId: "G-3Y9LT7JXY0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    getAnalytics(app); 
    
    // ØªØµØ¯ÙŠØ± Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.query = query;
    window.orderBy = orderBy;
    window.where = where;
</script>

<script>
    // ------------------------------------------------------------------
    // Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª (JavaScript) Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶ (Ù…Ø¹Ø¯Ù‘Ù„ Ù„Ù„ØªØ¨Ø³ÙŠØ·)
    // ------------------------------------------------------------------
    
    // Ø£Ø³Ù…Ø§Ø¡ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù„Ù„ØªØ±Ø¬Ù…Ø©
    const TYPE_NAMES = {
        'raw_materials': 'ğŸ“¦ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…',
        'labor_wages': 'ğŸ‘· Ø£Ø¬ÙˆØ± Ø¹Ù…Ø§Ù„',
        'factory_rent': 'ğŸ  Ø¥ÙŠØ¬Ø§Ø± Ù…ØµÙ†Ø¹',
        'electricity_water': 'âš¡ï¸ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…ÙŠØ§Ù‡',
        'general_maintenance': 'ğŸ› ï¸ ØµÙŠØ§Ù†Ø© Ø¹Ø§Ù…Ø©',
        'marketing': 'ğŸ“¢ ØªØ³ÙˆÙŠÙ‚',
        'transfer': 'ğŸšš ØªØ±Ø­ÙŠÙ„',
        'house_expenses': 'ğŸ¡ Ù†ÙÙ‚Ø§Øª Ù…Ù†Ø²Ù„',
        'asset_purchase': 'ğŸ’ Ø´Ø±Ø§Ø¡ Ø£ØµÙˆÙ„',
        'emergency': 'ğŸš¨ Ù…ØµØ±ÙˆÙ Ø·Ø§Ø±Ø¦/Ø³Ø±ÙŠØ¹'
    };
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„Ø©
    function formatCurrency(amount) {
        if (amount === 0 || isNaN(amount)) return '0.00';
        return `${parseFloat(amount).toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ±Ø¬Ù…Ø© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    function formatGroupTitle(key, groupBy) {
        if (groupBy === 'datePart') {
            const date = new Date(key + 'T00:00:00'); 
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('ar-EG', options);
        } else if (groupBy === 'type') {
            return TYPE_NAMES[key] || `Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ${key}`;
        } else {
            return 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©';
        }
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„Ø§ØªØ±
    function generateSummaryTitle(filterType, filterDateStart, filterDateEnd, grandTotal) {
        let title;
        const typeName = TYPE_NAMES[filterType] || filterType;
        
        if (grandTotal === 0) {
            title = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©';
        } else if (filterType && typeName) {
            // Ø­Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯
            title = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ØµØ±ÙˆÙØ§Øª ${typeName}`;
        } else {
            // Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ)
             title = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙƒÙ„ÙŠØ©';
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
        if (filterDateStart && filterDateEnd && filterDateStart !== filterDateEnd) {
            title += ` (Ù…Ù† ${filterDateStart} Ø¥Ù„Ù‰ ${filterDateEnd})`;
        } else if (filterDateStart && filterDateStart === filterDateEnd) {
             title += ` Ù„ÙŠÙˆÙ… ${filterDateStart}`;
        } else if (filterDateStart) {
             title += ` (Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† ${filterDateStart})`;
        } else if (filterDateEnd) {
             title += ` (Ø­ØªÙ‰ ${filterDateEnd})`;
        }
        
        return title;
    }


    // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Firebase
    async function loadExpenses() {
        const listContainer = document.getElementById('expensesList');
        const statusMessage = document.getElementById('statusMessage');
        const totalSummaryAmount = document.getElementById('totalSummaryAmount');
        const totalSummaryTitle = document.getElementById('totalSummaryTitle');
        const summaryCard = document.getElementById('summaryCard');
        
        const filterType = document.getElementById('filterType').value;
        const filterDateStart = document.getElementById('filterDateStart').value;
        const filterDateEnd = document.getElementById('filterDateEnd').value;
        const groupBy = document.getElementById('groupBy').value; 
        
        statusMessage.style.display = 'block';
        statusMessage.textContent = 'ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª... â³';
        listContainer.innerHTML = '';
        summaryCard.style.display = 'none';
        
        try {
            const expensesRef = collection(db, "expenses");
            let q;
            
            // 1. **Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…ÙØ¨Ø³Ù‘ÙØ· (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©):**
            // Ù†Ù‚ÙˆÙ… Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù…Ø§ Ø¨ÙØ±Ø² ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ø§Ù„ØªØ§Ø±ÙŠØ®)ØŒ Ø£Ùˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… where() Ù…Ø¹ orderBy() Ù…ØªØ·Ø§Ø¨Ù‚.
            
            if (filterType) {
                 // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹ (ÙØ±Ø² Ù…ØªØ·Ø§Ø¨Ù‚)
                 q = query(expensesRef, where("type", "==", filterType), orderBy("datePart", "desc"));
            } else {
                 // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø£Ùˆ Ø­Ø³Ø¨ Ø£ÙŠ ÙÙ„ØªØ± ØªØ§Ø±ÙŠØ® Ù…Ù†ÙØ±Ø¯ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ¯Ø¹Ù…Ù‡ ÙÙ‡Ø±Ø³ datePart Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
                 // Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø² Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· Ù„Ø¬Ù„Ø¨ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨ØªØ±ØªÙŠØ¨ Ù…Ù†Ø·Ù‚ÙŠ
                 q = query(expensesRef, orderBy("datePart", "desc"));
            }

            const querySnapshot = await getDocs(q);
            let expenses = [];
            
            querySnapshot.forEach((doc) => {
                expenses.push({ id: doc.id, ...doc.data() });
            });
            
            // 2. **ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ JavaScript:**
            
            expenses = expenses.filter(expense => {
                let match = true;
                
                // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¥Ø°Ø§ Ù„Ù… ØªØªÙ… ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…)
                if (filterDateStart && expense.datePart < filterDateStart) {
                    match = false;
                }
                if (filterDateEnd && expense.datePart > filterDateEnd) {
                    match = false;
                }
                
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ÙˆØ¹ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¥Ø°Ø§ Ù„Ù… ØªØªÙ… ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¹Ø§Ù…)
                if (!filterType && document.getElementById('filterType').value !== "" && expense.type !== document.getElementById('filterType').value) {
                    match = false;
                }

                return match;
            });

            // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            let grandTotal = expenses.reduce((sum, exp) => sum + exp.amount, 0);

            // 4. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙƒÙ„ÙŠ
            totalSummaryAmount.textContent = `${formatCurrency(grandTotal)} Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ`;
            totalSummaryTitle.textContent = generateSummaryTitle(filterType, filterDateStart, filterDateEnd, grandTotal);
            summaryCard.style.display = 'block';

            if (expenses.length === 0) {
                statusMessage.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø© ØªØ·Ø§Ø¨Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ÙÙ„Ø§ØªØ±. ğŸ™';
                return;
            }
            
            statusMessage.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            
            // 5. Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
            const groupedExpenses = expenses.reduce((groups, expense) => {
                const key = (groupBy === 'none') ? 'general' : expense[groupBy];
                
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(expense);
                return groups;
            }, {});
            
            // 6. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
            const sortedKeys = Object.keys(groupedExpenses).sort().reverse(); 

            for (const key of sortedKeys) {
                const groupExpenses = groupedExpenses[key];
                const groupTotal = groupExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                
                const groupCardDiv = document.createElement('div');
                groupCardDiv.className = 'group-card';
                
                const groupHeader = document.createElement('div');
                groupHeader.className = 'group-header';
                groupHeader.innerHTML = `
                    <h3>${formatGroupTitle(key, groupBy)}</h3>
                    <span class="group-total">${formatCurrency(groupTotal)} Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ</span>
                `;
                groupCardDiv.appendChild(groupHeader);
                
                // Ø§Ù„ÙØ±Ø² Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
                groupExpenses.sort((a, b) => new Date(b.fullDateTime) - new Date(a.fullDateTime));

                groupExpenses.forEach(expense => {
                    const expenseItemDiv = document.createElement('div');
                    expenseItemDiv.className = 'expense-item';
                    
                    const expenseDetailsDiv = document.createElement('div');
                    expenseDetailsDiv.className = 'expense-details';
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙƒØ§Ù…Ù„Ø§Ù‹
                    expenseDetailsDiv.innerHTML = `
                        <strong>${expense.detail}</strong>
                        <div class="expense-meta">
                            <span>ğŸ“… ${expense.datePart}</span>
                            <span>â±ï¸ ${expense.fullDateTime.split(' ')[1].substring(0, 5)}</span>
                            <span style="font-weight: 600;">${TYPE_NAMES[expense.type] || expense.type}</span>
                            <span>(${expense.paymentMethod})</span>
                        </div>
                    `;
                    
                    const expenseAmountSpan = document.createElement('span');
                    expenseAmountSpan.className = 'expense-amount';
                    expenseAmountSpan.textContent = formatCurrency(expense.amount);
                    
                    expenseItemDiv.appendChild(expenseDetailsDiv);
                    expenseItemDiv.appendChild(expenseAmountSpan);
                    
                    groupCardDiv.appendChild(expenseItemDiv);
                });
                
                listContainer.appendChild(groupCardDiv);
            }

        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:", error);
            // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø­Ù„ Ø§Ù„Ù…Ø¨Ø³Ù‘Ø·
            statusMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø®Ø·Ø£ Ø§ØªØµØ§Ù„ Ø£Ùˆ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©.) âŒ';
            statusMessage.style.display = 'block';
            totalSummaryAmount.textContent = '0.00 Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ';
        }
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    function resetFilters() {
        document.getElementById('filterType').value = '';
        document.getElementById('filterDateStart').value = '';
        document.getElementById('filterDateEnd').value = '';
        document.getElementById('groupBy').value = 'datePart'; 
        loadExpenses();
    }


    // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
        window.loadExpenses = loadExpenses; 
        window.resetFilters = resetFilters;
        loadExpenses(); // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    });
</script>

</body>
</html>
